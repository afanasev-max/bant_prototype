# app/core/prompts.py

SCHEMA_HINT = """
Проанализируй ответ менеджера и извлеки BANT-информацию. Верни ТОЛЬКО валидный JSON без дополнительного текста.

**Схема ответа:**
{
  "budget": {
    "have_budget": bool|null,        // true если есть бюджет, false если явно нет, null если неизвестно
    "amount_min": number|null,        // минимальная сумма в числовом формате
    "amount_max": number|null,        // максимальная сумма в числовом формате
    "currency": "RUB|USD|EUR|CNY|GBP"|null,  // ISO-4217 код валюты
    "comment": string|null            // дополнительный контекст о бюджете
  },
  "authority": {
    "decision_maker": string|null,    // ФИО или должность финального ЛПР
    "stakeholders": [string]|null,    // список участников согласования
    "decision_process": string|null,  // описание процесса принятия решения
    "risks": [string]|null            // потенциальные риски согласования
  },
  "need": {
    "pain_points": [string]|null,     // список ключевых болей клиента (минимум 2-3 для качественной квалификации)
    "current_solution": string|null,  // текущее решение проблемы
    "success_criteria": [string]|null,// критерии успеха проекта
    "priority": "low|medium|high|critical"|null  // приоритет решения проблемы
  },
  "timing": {
    "timeframe": "this_month|this_quarter|this_half|this_year|next_year|unknown"|null,
    "deadline": "YYYY-MM-DD"|null,    // жесткий дедлайн в формате ISO
    "next_step": string|null          // следующий шаг в процессе покупки
  }
}

**Правила извлечения:**
1. **Budget**: 
   - Если указан диапазон (например, "50-100 тысяч") → amount_min=50000, amount_max=100000
   - Если одна сумма (например, "около 75 тысяч") → amount_min=amount_max=75000
   - Фразы "есть бюджет" без суммы → have_budget=true, суммы null
   - "Бюджета нет" / "не заложено" / "нет денег" / "бюджет не выделен" → have_budget=false
   - Конвертируй тысячи/миллионы в полные числа (50к → 50000)

2. **Authority**:
   - Ищи ФИО, должности (CEO, директор, руководитель отдела)
   - stakeholders — все упомянутые роли кроме главного ЛПР
   - decision_process — описание этапов согласования, количества согласующих
   - "Не знаем" / "не определились" / "нет четкого ЛПР" → decision_maker=null

3. **Need**:
   - pain_points — конкретные проблемы, не общие фразы
   - "Проблем нет" / "все хорошо" / "ничего не беспокоит" → pain_points=[]
   - priority: critical (срочно, горит), high (важно, планируют), medium (рассматривают), low (интересуются)

4. **Timing**:
   - this_month — в течение месяца
   - this_quarter — до конца текущего квартала
   - this_half — до конца полугодия
   - this_year — до конца года
   - next_year — следующий год
   - unknown — неопределенные сроки / "не знаем" / "пока не планируем"

5. **Общие правила**:
   - Если информация отсутствует или неясна → null
   - НЕ додумывай данные, используй только явную информацию
   - Все строки на русском языке
   - Числа без пробелов и форматирования
   - **ВАЖНО**: Отрицательные ответы - это тоже валидные данные, не игнорируй их

**Примеры:**
Вход: "Бюджет примерно 500-700 тысяч рублей. Решает гендиректор Иванов, но нужно согласование с финансовым директором."
Выход: {"budget": {"have_budget": true, "amount_min": 500000, "amount_max": 700000, "currency": "RUB", "comment": null}, "authority": {"decision_maker": "Гендиректор Иванов", "stakeholders": ["Финансовый директор"], "decision_process": "Требуется согласование с финансовым директором", "risks": null}, ...}
"""

FOLLOWUP_HINT = """
Сгенерируй один конкретный уточняющий вопрос на русском языке для секции "{slot}" BANT-квалификации.

**Контекст:** {context}

**Требования:**
- Вопрос обращен к МЕНЕДЖЕРУ о его клиенте (используй "клиент", "заказчик", "у них", "у клиента")
- Короткий и прямой (не более 20 слов)
- Помогает заполнить конкретное отсутствующее поле
- Деловой тон, без формальностей
- БЕЗ вводных фраз ("Не могли бы вы...", "Подскажите пожалуйста...")
- Только сам вопрос, без пояснений

**Примеры хороших вопросов:**
- Budget: "Какой бюджет у клиента на проект?"
- Authority: "Кто у них финальный ЛПР?"
- Need: "Какая главная проблема у заказчика?"
- Timing: "Когда клиент планирует старт?"
"""

QUESTIONS = {
    "budget": "Какой бюджет у клиента на проект? Укажи сумму и валюту (если есть диапазон — укажи от и до).",
    "authority": "Кто у клиента принимает финальное решение? Кто еще участвует в согласовании?",
    "need": "Какие ключевые проблемы у клиента? Что используют сейчас? Как будут оценивать успех?",
    "timing": "Когда клиент планирует запуск? Есть ли жесткий дедлайн?"
}

SCORING_PROMPT = """
Оцени качество и полноту BANT-квалификации на основе предоставленных данных.

**Входные данные:** JSON BantRecord (без поля score)

**Выходной формат:** 
{
  "budget": {
    "value": 0-25,           // баллы по бюджету
    "confidence": 0.0-1.0,   // уверенность в данных
    "rationale": "string"    // краткое обоснование оценки
  },
  "authority": {
    "value": 0-25,
    "confidence": 0.0-1.0,
    "rationale": "string"
  },
  "need": {
    "value": 0-30,
    "confidence": 0.0-1.0,
    "rationale": "string"
  },
  "timing": {
    "value": 0-20,
    "confidence": 0.0-1.0,
    "rationale": "string"
  },
  "total": 0-100,            // сумма всех value
  "stage": "unqualified|qualified|ready"  // стадия лида
}

**Правила скоринга:**

**Budget (0-25 баллов):**
- 0-3: have_budget=null, данных нет
- 4-7: have_budget=false (явно указано, что бюджета нет)
- 8-12: have_budget=true, но нет сумм и валюты (только "есть бюджет")
- 13-19: указана валюта или одна из сумм (amount_min ИЛИ amount_max)
- 20-25: полные данные (amount_min, amount_max, currency) с комментарием или без

**Confidence:**
- 0.9-1.0: четкие числа и валюта
- 0.6-0.8: есть суммы, но размытый диапазон или непонятная валюта
- 0.3-0.5: только общие фразы "есть бюджет"
- 0.0-0.2: нет данных или противоречия

**Authority (0-25 баллов):**
- 0-5: decision_maker=null, нет информации о ЛПР
- 6-10: decision_maker="не знаем"/"не определились" (явно указано отсутствие ЛПР)
- 11-17: есть конкретный decision_maker (ФИО или должность)
- 18-22: есть decision_maker + stakeholders (минимум 1)
- 23-25: полная картина (ЛПР + stakeholders + decision_process + возможно risks)

**Confidence:**
- 0.9-1.0: ФИО и должность ЛПР, описан процесс
- 0.6-0.8: только должность ЛПР
- 0.3-0.5: неясно кто ЛПР
- 0.0-0.2: нет данных

**Need (0-30 баллов):**
- 0-5: pain_points=null, нет описания проблем или потребностей
- 6-12: pain_points=[] (явно указано, что проблем нет) ИЛИ есть 1 pain_point
- 13-18: есть 2+ конкретных pain_points ИЛИ success_criteria
- 19-24: есть 2+ pain_points И success_criteria
- 25-27: + указана current_solution
- 28-30: полная картина + priority=high или critical

**Confidence:**
- 0.9-1.0: детальное описание болей и критериев успеха
- 0.6-0.8: есть боли, но нет критериев
- 0.3-0.5: общие фразы без конкретики
- 0.0-0.2: нет данных

**Timing (0-20 баллов):**
- 0-3: timeframe=null, нет информации о сроках
- 4-7: timeframe=unknown (явно указано, что сроки неопределенные)
- 8-12: timeframe=next_year или очень размытые сроки
- 13-16: timeframe=this_year
- 17-20: timeframe=this_half, this_quarter, this_month ИЛИ есть конкретный deadline

**Confidence:**
- 0.9-1.0: точная дата deadline
- 0.6-0.8: четкий timeframe (квартал/месяц)
- 0.3-0.5: расплывчатые сроки
- 0.0-0.2: нет данных

**Определение stage:**
- **ready**: total ≥ 80 И все компоненты имеют confidence ≥ 0.6 И нет компонентов с value < 15
- **qualified**: total ≥ 60 И нет компонентов с value < 10 (но не достигает критериев ready)
- **unqualified**: все остальные случаи

**Требования к rationale:**
- Краткое объяснение на русском (1-2 предложения)
- Указание что учтено и что отсутствует
- Конкретика по данным

Верни ТОЛЬКО валидный JSON, никаких дополнительных комментариев.
"""

FOLLOWUP_GEN_PROMPT = """
Проанализируй BANT-данные и сгенерируй целевые уточняющие вопросы для менеджера о его клиенте.

**Входные данные:**
- BantRecord: текущие BANT-данные
- BantScore: оценки по каждой секции

**Выходной формат:**
{
  "followups": {
    "budget": [string, ...],      // максимум 2 вопроса
    "authority": [string, ...],   // максимум 2 вопроса
    "need": [string, ...],        // максимум 2 вопроса
    "timing": [string, ...]       // максимум 2 вопроса
  }
}

**КРИТИЧЕСКИ ВАЖНЫЕ ПРАВИЛА:**

1. **НЕ ЗАДАВАЙ ПОВТОРНЫЕ ВОПРОСЫ:**
   - Если клиент уже дал четкий ответ (даже отрицательный), НЕ задавай тот же вопрос снова
   - Если have_budget=false, НЕ спрашивай про бюджет повторно
   - Если decision_maker указан, НЕ спрашивай "кто принимает решение" снова
   - Если pain_points уже указаны, НЕ спрашивай "какие проблемы" повторно
   - Если timeframe указан, НЕ спрашивай "когда планируют" снова

2. **ПРИНИМАЙ ОТРИЦАТЕЛЬНЫЕ ОТВЕТЫ:**
   - "Нет бюджета" = have_budget=false, НЕ задавай уточнения
   - "Не знаем сроки" = timeframe=unknown, НЕ спрашивай про дедлайны
   - "Нет четкого ЛПР" = decision_maker=null, НЕ задавай повторные вопросы
   - "Проблем нет" = pain_points=[], НЕ спрашивай про боли снова

3. **Пороги для генерации followup (ТОЛЬКО для неопределенных данных):**
   - Budget: value < 12 И have_budget=null (не задавай если have_budget=false)
   - Authority: value < 12 И decision_maker=null
   - Need: value < 15 И (pain_points=null ИЛИ len(pain_points)=0)
   - Timing: value < 8 И timeframe=null

4. **Качество вопросов:**
   - Короткие (до 15 слов)
   - Обращены к МЕНЕДЖЕРУ о клиенте (используй "клиент", "у них", "заказчик", "у клиента")
   - Конкретные, направленные на заполнение пробела
   - Деловой тон, без излишней вежливости
   - БЕЗ вводных конструкций ("Не могли бы вы...", "Подскажите пожалуйста...")
   - На русском языке

5. **Логика выбора вопросов (ТОЛЬКО для null/пустых значений):**
   - Если budget.have_budget=null → "Есть ли у клиента заложенный бюджет?"
   - Если authority.decision_maker=null → "Кто у клиента финальный ЛПР?"
   - Если need.pain_points=null ИЛИ [] → "Какая основная боль у заказчика?"
   - Если timing.timeframe=null → "Когда клиент планирует запуск?"

6. **НЕ генерируй вопросы если:**
   - Клиент уже дал четкий ответ (даже отрицательный)
   - Секция имеет value > порога И confidence ≥ 0.7
   - Данных достаточно для квалификации
   - Это повторный вопрос по уже отвеченной теме

**Примеры правильного тона:**
✅ "Какой бюджет у клиента на проект?" (только если have_budget=null)
✅ "Кто у них принимает решение?" (только если decision_maker=null)
✅ "Какая главная боль у заказчика?" (только если pain_points=null/[])

❌ "Какой у вас бюджет?" (обращение к менеджеру как к клиенту)
❌ "Какие проблемы вас беспокоят?" (неправильный адресат)
❌ "Не могли бы вы уточнить..." (излишняя вежливость)
❌ Повторные вопросы по уже отвеченным темам

**Пример:**
Вход: Budget have_budget=false, Authority decision_maker=null, Need pain_points=["проблема1"], Timing timeframe="this_quarter"
Выход: {"followups": {"budget": [], "authority": ["Кто у клиента финальный ЛПР?"], "need": [], "timing": []}}

Верни ТОЛЬКО валидный JSON без дополнительного текста.
"""
