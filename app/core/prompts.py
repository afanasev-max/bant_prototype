# app/core/prompts.py

SCHEMA_HINT = r"""
Проанализируй ответ менеджера и извлеки BANT-информацию. Верни ТОЛЬКО валидный JSON без дополнительного текста.

Контекст времени: {current_date}

Схема ответа:
{{
  "budget": {{
    "have_budget": true|false|null,
    "amount_min": 0|null,
    "amount_max": 0|null,
    "currency": "RUB"|"USD"|"EUR"|"CNY"|"GBP"|null,
    "comment": "string"|null,
    "budget_status": "NOT_ASKED"|"NO_BUDGET"|"AVAILABLE"|null
  }},
  "authority": {{
    "decision_maker": "string"|null,
    "stakeholders": ["string"]|null,
    "decision_process": "string"|null,
    "risks": ["string"]|null,
    "uncertain": true|false|null
  }},
  "need": {{
    "pain_points": ["string"]|null,
    "current_solution": "string"|null,
    "success_criteria": ["string"]|null,
    "priority": "low"|"medium"|"high"|"critical"|null
  }},
  "timing": {{
    "timeframe": "this_month"|"this_quarter"|"this_half"|"this_year"|"next_year"|"unknown"|null,
    "deadline": "YYYY-MM-DD"|null,
    "next_step": "string"|null
  }}
}}

Правила извлечения:

Budget:
- Если указан диапазон (например, "50-100 тысяч") → amount_min=50000, amount_max=100000
- Если одна сумма (например, "около 75 тысяч") → amount_min=amount_max=75000
- Фразы "есть бюджет" без суммы → have_budget=true, суммы null
- КРИТИЧЕСКИ ВАЖНО: Различай отсутствие информации и отсутствие бюджета:
  * "не знаю" / "не имею понятия" / "не спрашивал" / "не обсуждали" → have_budget=null, budget_status="NOT_ASKED"
  * "нет бюджета" / "не заложено" / "нет денег" / "бюджет не выделен" → have_budget=false, budget_status="NO_BUDGET"
  * "есть бюджет" / конкретные суммы → have_budget=true, budget_status="AVAILABLE"
- Конвертируй тысячи/миллионы в полные числа (50к → 50000)

Authority:
- Ищи ФИО, должности (CEO, директор, руководитель отдела)
- stakeholders — все упомянутые роли кроме главного ЛПР
- decision_process — описание этапов согласования, количества согласующих
- КРИТИЧЕСКИ ВАЖНО: Различай неопределенность и конкретную информацию:
  * "не знаю" / "не определились" / "не знаем" / "без понятия" / "не в курсе" → decision_maker="не знаем", uncertain=null
  * "вроде X" / "кажется X" / "может быть X" / "похоже на X" → decision_maker=X, uncertain=true (сохраняй конкретную информацию!)
  * "точно X" / "определенно X" / "X решает" → decision_maker=X, uncertain=false

Need:
- pain_points — конкретные проблемы, не общие фразы
- "Проблем нет" / "все хорошо" / "ничего не беспокоит" / "не знаем" / "не определились" / "без понятия" / "не в курсе" → pain_points=[]
- priority: critical (срочно, горит), high (важно, планируют), medium (рассматривают), low (интересуются)

Timing:
- this_month — в течение месяца
- this_quarter — до конца текущего квартала
- this_half — до конца полугодия
- this_year — до конца года
- next_year — следующий год
- unknown — неопределенные сроки / "не знаем" / "пока не планируем" / "не определились" / "без понятия" / "не в курсе"
- КРИТИЧЕСКИ ВАЖНО: 
  * deadline только для конкретных дат (например, "15 марта 2024"), НЕ для общих периодов
  * "до конца года" → timeframe="this_year", deadline=null
  * "в следующем квартале" → timeframe="next_quarter", deadline=null
  * "в течение месяца" → timeframe="this_month", deadline=null
  * НЕ записывай общие периоды как deadline!

Общие правила:
- Если информация отсутствует или неясна → null
- НЕ додумывай данные, используй только явную информацию
- Все строки на русском языке
- Числа без пробелов и форматирования
- КРИТИЧЕСКИ ВАЖНО: Отрицательные ответы ("не знаю", "нет", "не определились") - это ВАЛИДНЫЕ данные, НЕ игнорируй их!

Примеры:
Вход: "Бюджет примерно 500-700 тысяч рублей. Решает гендиректор Иванов, но нужно согласование с финансовым директором."
Выход: {"budget": {"have_budget": true, "amount_min": 500000, "amount_max": 700000, "currency": "RUB", "comment": null}, "authority": {"decision_maker": "Гендиректор Иванов", "stakeholders": ["Финансовый директор"], "decision_process": "Требуется согласование с финансовым директором", "risks": null}, ...}
"""

FOLLOWUP_HINT = """
Сгенерируй один конкретный уточняющий вопрос на русском языке для секции "{slot}" BANT-квалификации.

**Контекст:** {context}

**Требования:**
- Вопрос обращен к МЕНЕДЖЕРУ о его клиенте (используй "клиент", "заказчик", "у них", "у клиента")
- Короткий и прямой (не более 20 слов)
- Помогает заполнить конкретное отсутствующее поле
- Деловой тон, без формальностей
- БЕЗ вводных фраз ("Не могли бы вы...", "Подскажите пожалуйста...")
- Только сам вопрос, без пояснений

**Примеры хороших вопросов:**
- Budget: "Какой бюджет у клиента на проект?"
- Authority: "Кто у них финальный ЛПР?"
- Need: "Какая главная проблема у заказчика?"
- Timing: "Когда клиент планирует старт?"
"""

QUESTIONS = {
    "budget": """Есть ли у клиента выделенный бюджет на проект?

Помогите уточнить для квалификации:
• Спросите: "Говорили ли вы с клиентом о бюджете?"
• Узнайте: "Есть ли у них заложенные средства на этот проект?"
• Выясните: "Сравнивают ли они с другими подрядчиками по цене?"

Опишите, что клиент говорил о финансах""",
    
    "authority": """Кто у клиента принимает финальное решение?

Помогите выяснить для квалификации:
• Спросите: "С кем вы общались на встрече?"
• Узнайте: "Этот человек сказал 'я решу' или 'нужно согласовать'?"
• Выясните: "Кто еще участвует в принятии решений?"

Опишите, что клиент говорил о процессе принятия решений""",
    
    "need": """Какие проблемы клиента вы выявили на встрече?

Помогите структурировать информацию:
• Что клиент говорил о своих сложностях?
• На что он жаловался в текущих процессах?
• Какой результат хочет получить от проекта?
• Что будет, если ничего не изменится?

Опишите, что клиент говорил о своих проблемах""",
    
    "timing": """Когда клиент планирует запуск?

Помогите уточнить для квалификации:
• Спросите: "Это жесткий дедлайн или можно сдвинуть?"
• Узнайте: "С чем связаны эти сроки?"
• Выясните: "Что будет, если не успеем к этому времени?"
• Уточните: "Есть ли внешние факторы, влияющие на сроки?"

Опишите, что клиент говорил о сроках"""
}

SCORING_PROMPT = """
Оцени качество и полноту BANT-квалификации на основе предоставленных данных.

**Входные данные:** JSON BantRecord (без поля score)

**Выходной формат:** 
{
  "budget": {
    "value": 0-25,           // баллы по бюджету
    "confidence": 0.0-1.0,   // уверенность в данных
    "rationale": "string"    // краткое обоснование оценки
  },
  "authority": {
    "value": 0-25,
    "confidence": 0.0-1.0,
    "rationale": "string"
  },
  "need": {
    "value": 0-30,
    "confidence": 0.0-1.0,
    "rationale": "string"
  },
  "timing": {
    "value": 0-20,
    "confidence": 0.0-1.0,
    "rationale": "string"
  },
  "total": 0-100,            // сумма всех value
  "stage": "unqualified|qualified|ready"  // стадия лида
}

**Правила скоринга:**

**Budget (0-25 баллов):**
- 0-2: have_budget=null, данных нет
- 3-5: have_budget=false (явно указано, что бюджета нет) - это валидный ответ, но низкий скор
- 6-10: have_budget=true, но нет сумм и валюты (только "есть бюджет")
- 11-18: указана валюта или одна из сумм (amount_min ИЛИ amount_max)
- 19-25: полные данные (amount_min, amount_max, currency) с комментарием или без

**Confidence:**
- 0.9-1.0: четкие числа и валюта
- 0.6-0.8: есть суммы, но размытый диапазон или непонятная валюта
- 0.3-0.5: только общие фразы "есть бюджет" или "нет бюджета"
- 0.0-0.2: нет данных или противоречия

**Authority (0-25 баллов):**
- 0-2: decision_maker=null, нет информации о ЛПР
- 3-5: decision_maker="не знаем"/"не определились" (явно указано отсутствие ЛПР) - это валидный ответ, но низкий скор
- 6-12: есть конкретный decision_maker (ФИО или должность)
- 13-18: есть decision_maker + stakeholders (минимум 1)
- 19-25: полная картина (ЛПР + stakeholders + decision_process + возможно risks)

**Confidence:**
- 0.9-1.0: ФИО и должность ЛПР, описан процесс
- 0.6-0.8: только должность ЛПР
- 0.3-0.5: неясно кто ЛПР или "не знаем"
- 0.0-0.2: нет данных

**Need (0-30 баллов):**
- 0-2: pain_points=null, нет описания проблем или потребностей
- 3-5: pain_points=[] (явно указано, что проблем нет) - это валидный ответ, но низкий скор
- 6-12: есть 1-2 конкретных pain_points ИЛИ success_criteria
- 13-18: есть 2+ pain_points И success_criteria
- 19-24: + указана current_solution
- 25-30: полная картина + priority=high или critical

**Confidence:**
- 0.9-1.0: детальное описание болей и критериев успеха
- 0.6-0.8: есть боли, но нет критериев
- 0.3-0.5: общие фразы без конкретики или "проблем нет"
- 0.0-0.2: нет данных

**Timing (0-20 баллов):**
- 0-2: timeframe=null, нет информации о сроках
- 3-5: timeframe=unknown (явно указано, что сроки неопределенные) - это валидный ответ, но низкий скор
- 6-10: timeframe=next_year или очень размытые сроки
- 11-15: timeframe=this_year
- 16-20: timeframe=this_half, this_quarter, this_month ИЛИ есть конкретный deadline

**Confidence:**
- 0.9-1.0: точная дата deadline
- 0.6-0.8: четкий timeframe (квартал/месяц)
- 0.3-0.5: расплывчатые сроки или "unknown"
- 0.0-0.2: нет данных

**Определение stage:**
- **ready**: total ≥ 80 И все компоненты имеют confidence ≥ 0.6 И нет компонентов с value < 15
- **qualified**: total ≥ 60 И нет компонентов с value < 8 (но не достигает критериев ready)
- **unqualified**: все остальные случаи (включая случаи с отрицательными ответами "не знаю", "нет", "unknown")

**Требования к rationale:**
- Краткое объяснение на русском (1-2 предложения)
- Указание что учтено и что отсутствует
- Конкретика по данным
- Для отрицательных ответов ("не знаю", "нет", "unknown") - дай рекомендации по уточнению
- Используй деловой тон, как будто консультируешь менеджера

Верни ТОЛЬКО валидный JSON, никаких дополнительных комментариев.
"""

FOLLOWUP_GEN_PROMPT = """
Проанализируй BANT-данные и сгенерируй целевые уточняющие вопросы для менеджера о его клиенте.

**Входные данные:**
- BantRecord: текущие BANT-данные
- BantScore: оценки по каждой секции
- История вопросов: {history}

**Выходной формат:**
{
  "followups": {
    "budget": [string, ...],      // максимум 2 вопроса
    "authority": [string, ...],   // максимум 2 вопроса
    "need": [string, ...],        // максимум 2 вопроса
    "timing": [string, ...]       // максимум 2 вопроса
  }
}

**КРИТИЧЕСКИ ВАЖНЫЕ ПРАВИЛА:**

1. **ГЕНЕРИРУЙ FOLLOWUP ДЛЯ ОТРИЦАТЕЛЬНЫХ ОТВЕТОВ:**
   - Если have_budget=false, задавай уточняющие вопросы про готовность платить
   - Если decision_maker="не знаем", задавай вопросы про контакты и роли
   - Если pain_points=[], задавай вопросы про цели и результаты
   - Если timeframe="unknown", задавай вопросы про приоритет и срочность

2. **ИСПОЛЬЗУЙ ПРОАКТИВНЫЕ ПОДСКАЗКИ:**
   - Добавляй подсказки в скобках для сложных вопросов
   - Предлагай варианты ответов
   - Объясняй, зачем нужна информация

3. **Пороги для генерации followup:**
   - Budget: value < 15 (включая отрицательные ответы)
   - Authority: value < 15 (включая "не знаем")
   - Need: value < 15 (включая пустые pain_points)
   - Timing: value < 10 (включая "unknown")

4. **Качество вопросов:**
   - Короткие (до 15 слов)
   - Обращены к МЕНЕДЖЕРУ о клиенте (используй "клиент", "у них", "заказчик", "у клиента")
   - Конкретные, направленные на заполнение пробела
   - Деловой тон, без излишней вежливости
   - БЕЗ вводных конструкций ("Не могли бы вы...", "Подскажите пожалуйста...")
   - На русском языке
   - Учитывай контекст предыдущих вопросов

5. **Примеры улучшенных followup вопросов:**

**Budget (если have_budget=false):**
- "Говорил ли клиент про деньги вообще? Какая была реакция на тему цены?"
- "Сравнивает ли с другими подрядчиками? Называл ли примерные суммы?"

**Authority (если decision_maker='не знаем'):**
- "С кем вы общались? (должность/роль) Этот человек сказал 'я решу' или 'нужно согласовать'?"
- "Размер компании примерно? (1-10 / 10-50 / 50+ человек) Упоминал ли кого-то, с кем нужно обсудить?"

**Need (если pain_points=[]):**
- "Что клиент хочет получить на выходе? (конкретный результат) Что его НЕ устраивает сейчас?"
- "Зачем ему вообще это нужно? Что изменится? Если проект не сделать - что произойдет?"

**Timing (если timeframe='unknown'):**
- "Почему именно сейчас? Что подтолкнуло к запуску? Есть ли у него внешнее давление?"
- "Если сделаем через 3 месяца - это критично? Он ждет только вас или параллельно ищет других?"

**Пример:**
Вход: Budget have_budget=false, Authority decision_maker="не знаем", Need pain_points=[], Timing timeframe="unknown"
Выход: {"followups": {"budget": ["Говорил ли клиент про деньги вообще? Какая была реакция на тему цены?"], "authority": ["С кем вы общались? (должность/роль) Этот человек сказал 'я решу' или 'нужно согласовать'?"], "need": ["Что клиент хочет получить на выходе? (конкретный результат) Что его НЕ устраивает сейчас?"], "timing": ["Почему именно сейчас? Что подтолкнуло к запуску? Есть ли у него внешнее давление?"]}}

Верни ТОЛЬКО валидный JSON без дополнительного текста.
"""
